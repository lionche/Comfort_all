{% load static %}
<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
    <meta charset="UTF-8">
    <title>测试用例</title>
</head>
{#<script src="https://cdn.bootcss.com/ace/1.4.6/ace.js"></script>#}
{#<script src="https://cdn.bootcss.com/ace/1.4.6/ext-beautify.js"></script>#}
{#<script src="https://cdn.bootcss.com/ace/1.4.6/ext-language_tools.js"></script>#}
{#<script src="https://cdn.bootcss.com/ace/1.4.6/theme-monokai.js"></script>#}
{#<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js" type="text/javascript"></script>#}
{#<script src="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" type="text/javascript"></script>#}

<script src="{% static "js/ace/src/ace.js" %}" type="text/javascript" charset="utf-8"></script>
<script src="{% static "js/ace/src/ext-beautify.js" %}" type="text/javascript" charset="utf-8"></script>
<script src="{% static "js/ace/src/ext-language_tools.js" %}" type="text/javascript" charset="utf-8"></script>
<script src="{% static "js/ace/src/theme-monokai.js" %}" type="text/javascript" charset="utf-8"></script>
<script src="{% static "js/jquery-3.6.0.js" %}" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>


<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
      integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

<!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css"
      integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
        integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
        crossorigin="anonymous"></script>


<body onload="go_harness()">


<div id="main" style="width:100%; height:100%;padding:40px;position: absolute">

    {#    <h1 style="text-align: center;color: gray;padding-bottom: 40px">在线分析系统</h1>#}
    <h1 style="text-align: left;color: gray;padding-bottom: 40px">在线分析系统 <span
            class="badge badge-secondary">JavaScript</span></h1>

    <div id="left" style="float:left ; width:45%; height:100%;">

        {#id搜索框#}
        <div>
            <form class="bs-example bs-example-form" role="form" method="get" onsubmit="check()">
                <div class="col-lg-6">
                    <div class="input-group">
                        <input type="number" class="form-control" name="id" id="testcase_id"
                               placeholder="{{ Testcase_id }}" autocomplete="off">
                        <span class="input-group-btn">
						<button class="btn btn-default" type="submit">
							搜索🆔
						</button>
					</span>
                    </div><!-- /input-group -->
                </div><!-- /.col-lg-6 -->
            </form>
        </div>
        <br>

        {#输入分析框#}
        <div>
            {% if different_result_list|length != 0 %}

                <form class="navbar-form navbar-left">
                    <div class="form-group">
                        <textarea id="remark_content_ajax_id" placeholder="Search"
                                  class="form-control" rows="3"
                                  autocomplete="off">{% if now_remark %}{{ now_remark }}{% endif %}</textarea>
                    </div>
                    <button type="button" class="btn btn-default" id="b4">保存分析</button>
                </form>

            {% endif %}

            <script>
                $(document).ready(function () {
                    $("#b4").on("click", function () {
                        $.ajax({
                            url: "/analysis/remark_ajax/",
                            type: "POST",
                            data: {
                                "remark_ajax": $("#remark_content_ajax_id").val(),
                            },
                            success: function (data) {
                                console.log(data)
                                window.alert("保存好惹👌🏻");
                                {#    弹出框#}
                            }
                        })
                    })
                })


            </script>
        </div>

        <br>


        {#代码提交框#}
        <style>
            #editor {
                width: 100%;
                height: 700px;
            }
        </style>
        <div>
            <div id="editor"></div>
            <form>
                <textarea name="testcase_content_ajax" id="testcase_content_ajax_id"
                          placeholder='请输入用例'>{{ harness_result.testcase_context }}</textarea>
                <input type="button" value="开始测试！" id="b3">
            </form>
            <script>

                {#    代码编辑框#}
                var editor_ajax = ace.edit('editor');
                editor_ajax.getSession().setValue(`{{ harness_result.testcase_context|safe }}`)

                var content_ajax_textarea = document.getElementById('testcase_content_ajax_id')

                content_ajax_textarea.hidden = true

                editor_ajax.getSession().on('change', function (e) {
                    content_ajax_textarea.value = editor_ajax.getSession().getValue()
                });
                {#代码提示#}
                editor_ajax.setOptions({
                    enableBasicAutocompletion: true,
                    enableSnippets: true,
                    enableLiveAutocompletion: true
                });

                {#editor_ajax.setTheme("ace/theme/monokai");#}

                editor_ajax.getSession().setMode("ace/mode/javascript")
                editor_ajax.setFontSize(13)

                const go_harness = function () {
                    $.ajax({
                        url: "/analysis/herness_ajax/",
                        type: "POST",
                        data: {
                            "herness_ajax": $("#testcase_content_ajax_id").val(),
                        },
                        success: function (data) {
                            const obj = JSON.parse(data);
                            {#console.log(obj)#}
                            {#console.log(obj.harness_result)#}
                            const obj_harness_result = JSON.parse(obj.harness_result);
                            const obj_different_result_list = JSON.parse(obj.different_result_list);
                            {#console.log(obj_different_result_list)#}
                            createTable_harness_result(obj_harness_result.Harness_Result);
                            createTable_different_result_list(obj_different_result_list);
                        }
                    })
                };


                $(document).ready(function () {
                    $("#b3").on("click", go_harness)
                })

                var testbed_info = {
                    1: 'v8',
                    2: 'spiderMonkey',
                    3: 'chakra',
                    4: 'jsc',
                    5: 'quickjs',
                    6: 'jerryscript',
                    7: 'graaljs',
                    8: 'hermes',
                    9: 'chakra-beta'
                }
                {#更新差分结果表#}

                function createTable_harness_result(obj) {
                    var data = obj.outputs
                    var tableStr = "<table class='table table-hover'>";
                    tableStr = tableStr
                        + "<tr>"
                        + "<th >Testcase Id</th>"
                        + "<th >Engine Id</th>"
                        + "<th >Engine</th>"
                        + "<th>Stdout</th>"
                        + "<th>Stderr</th>"
                        + "<th>Returncode</th>"
                        + "</tr>";

                    var len = data.length;

                    for (var i = 0; i < len; i++) {
                        tableStr = tableStr + "<tr>"
                            + "<td>" + obj.testcase_id + "</td>"
                            + "<td>" + data[i].testbed_id + "</td>"
                            + "<td>" + testbed_info[data[i].testbed_id] + "</td>"
                            + "<td>" + data[i].stdout + "</td>"
                            + "<td>" + data[i].stderr + "</td>"
                            + "<td>" + data[i].returncode + "</td>"
                            + "</tr>";
                    }

                    tableStr = tableStr + "</table>";
                    //添加到div中
                    console.log(tableStr)
                    $("#tableHarnessResultAjax").html(tableStr);
                }

                {#更新可疑结果表#}

                function createTable_different_result_list(obj) {
                    var tableStr = '<h1 style="font-size:20px;font-family:times;color:green">没有触发问题</h1>'

                    var len = obj.length;
                    if (len != 0) {
                        tableStr = "<table class='table table-hover'>";
                        tableStr = tableStr
                            + "<tr>"
                            + "<th >Testcase Id</th>"
                            + "<th >Error Type</th>"
                            + "<th >Engine Id</th>"
                            + "<th >Engine</th>"
                            + "</tr>";

                    }
                    for (var i = 0; i < len; i++) {

                        {#console.log(obj[i].testcase_id)#}
                        {#console.log(obj[i].error_type)#}
                        {#console.log(obj[i].testbed_id)#}

                        tableStr = tableStr + "<tr>"
                            + "<td>" + obj[i].testcase_id + "</td>"
                            + "<td>" + obj[i].error_type + "</td>"
                            + "<td>" + obj[i].testbed_id + "</td>"
                            + "<td>" + testbed_info[obj[i].testbed_id] + "</td>"
                            + "</tr>";
                    }

                    tableStr = tableStr + "</table>";
                    //添加到div中
                    console.log(tableStr)
                    $("#tableDifferentResultAjax").html(tableStr);
                }

            </script>

        </div>


        <script>
            {#如果搜索id是空则返回当前id#}

            function check() {
                var testcase_id = document.getElementById('testcase_id')
                {#console.log(testcase_id.value)#}
                {#console.log(testcase_id.value==='')#}
                if (testcase_id.value === '') {

                    {#alert("不能为空");#}
                    testcase_id.value =
                    {{ Testcase_id }}
                    {#console.log(testcase_id.value)#}
                    {#return false#}

                }
                return true
            }
        </script>


        {#比对不同#}


    </div>


    <div id="right" style="float:right ; width:45%; height:100%;">
        <div id="tableDifferentResultAjax"></div>

        <br>

        <div id="tableHarnessResultAjax"></div>
        <br>
        {{ returncode }}
    </div>


</body>


</html>